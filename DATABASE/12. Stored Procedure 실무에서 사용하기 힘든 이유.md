# 12. Stored Procedure 실무에서 사용하기 힘든 이유

Stored Procedure는 비즈니스 로직 구현을 주로 담당한다. 따라서 stored procedure를 사용한다는 것은 로직과 관련된 연산을 Data-tier에 두는 것을 의미한다.



### Stored Procedure의 장점

#### 1. App에 대해 transparent
    
>서버를 재배포할 때 각 배치마다 실행하는 로직을 stored procedure로 구현해놓으면, 백엔드에서는 그 프로시저만 호출하면 된다. 그러면 각 배치에서 프로시저를 호출할 때마다 프로시저의 수행 내용이 달라진다. 이를 transparent 하다고 한다.
    
#### 2. network traffic 감소 → 성능 향상
    
>모든 쿼리문을 백엔드에서 처리하면 매번 DB I/O가 발생하여 network traffic이 증가한다. 그런데 여러 개의 쿼리문을 묶어서 stored procedure에 넣어두면 DB 접근 횟수가 훨씬 줄어들기 때문에 응답 속도가 향상된다.
    
#### 3. 재사용 가능
    
>여러 서비스에서 공통으로 이용하는 로직을 stored procedure로 만들어 서비스들이 공통적으로 사용하도록 할 수 있다. 여러 서비스에 모두 구현을 해놓지 않아도 되기 때문에 편리하다. 
    
#### 4. 백엔드에서 개인정보에 직접 접근하는 것을 제한 → 보안 향상
    
>민감한 정보에 대한 연산이나 조회를 모두 Data tier에서 처리함으로써 보안을 강화할 수 있다.

<br><br>

### Stored Procedure의 단점

#### 1. 유지/보수성 하락
    
>로직이 변경되거나 업데이트될 때 백엔드뿐만 아니라 프로시저도 업데이트 해야한다. 또한 프로시저만 업데이트하려고 해도 백엔드 코드까지 변경되기 때문에 재배포가 필요해진다. 이런 면에서 stored procedure는 유지, 관리 비용이 커진다.
    
#### 2. DB 서버의 부하 증가
    
>비즈니스 로직을 DB 서버에서 들고있으면, 갑자기 고객 트래픽이 올릴 경우 백엔드 서버의 stored procedure 호출이 증가한다. 그렇게 되면 DB 서버의 부하가 증가하게 된다.
>   
>이것 자체도 문제지만, 해결책이 있긴 하다. 이렇게 DB 트래픽이 몰릴 경우 DB 서버를 추가해주면 된다. 그러나 DB 서버를 하나 더 추가하는 것은 복잡한 작업이다. 새로운 DB 서버를 추가하고, 데이터를 복제하는데 걸리는 시간과 리소스가 많이 들기 때문에 유사시에 실시간으로 대응하기 힘들다. 이와 달리 백엔드 서버를 늘리는 건 비교적 간단한 작업이다.
    
#### 3. App에 대해 transparent하지 않을 수도 있다.
    
>stored procedure가 애플리케이션에 transparent하도록 하려면 제한 사항이 많다. 프로시저의 이름만 변경하려고 해도 이를 참조하고 있는 수많은 백엔드 서버가 있기 때문에, transparent하게 유지하기 위한 관리 비용이 더 커질 수 있다.
    
#### 4. transparent한 것이 마냥 좋은 건 아니다.
    
>transparent한 앱 설계에선 만약 구현한 코드에 버그가 있을 경우 모니터링이 어렵다. 모든 백엔드 서버가 하나의 프로시저를 사용하기 때문에 만약 그 프로시저에 버그가 있을 경우 피해 규모가 더 크다.
    
#### 5. logic tier에서도 성능 향상 가능
    
>순차적으로 진행할 필요가 없는 작업들은 멀티스레딩을 통해 병렬로 처리하거나, 캐싱 기능을 통해 성능을 향상시킬 수 있다. 심지어 DB 서버 부하도 줄일 수 있다.

```
데이터베이스 캐싱에서 캐시 무결성을 유지하기 위한 방안

1. Invalidation(무효화):
    데이터가 데이터베이스에서 변경될 때 캐시를 무효화. 직후 요청은 데이터베이스에서 직접 읽음
    
2. Expiration(만료):
    캐시에 만료 시간 설정.
    
3. Update-on-Write(쓰기 시 업데이트):
    데이터가 변경될 때 캐시도 함께 업데이트.
    
4. Lazy Loading(지연 로딩):
    캐시된 데이터가 요청될 때, 데이터베이스와의 일치 여부를 검사하고, 필요한 경우 캐시를 업데이트.
    
5. Write-Through Caching(쓰기-통과 캐싱):
    데이터가 업데이트 될 때, 캐시와 데이터베이스 모두에 쓰기 작업을 수행.
```
#### 6. 100% 보안이 보장되진 않음
    
>보안을 최대로 강화하게 되면, 개발 외에도 운영적인 측면에서 신속함이 떨어지기 때문에 완벽한 보안은 현실적으로 보장할 수 없다.
    

#### 7. 그 외 - 가독성 떨어짐, 일부 RDBMS에서 디버깅 어려움
<br>

### ➡️ 결론

(쉬운코드 님의 개인적 소견)<br>
**Stored Procedure는 장점도 있지만, 단점 또한 많다. 그리고 최신 프로그래밍 언어에서는 이런 프로시저를 대체할 수 있는 기능을 많이 지원하기 때문에** 실무에서 stored procedure를 사용할 이유가 점차 사라지고 있다.
그러나 이것은 당연히 상황마다, 회사마다 다르기 때문에 때에 따라 적절하게 사용해야 한다.
